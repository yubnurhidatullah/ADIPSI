name: Build ADIPSI Frontend (auto-detect)

on:
  workflow_dispatch: {}

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout (Barang-Baru)
        uses: actions/checkout@v4
        with:
          ref: Barang-Baru

      - name: Use Node LTS
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Detect project directory (package.json with scripts)
        id: detect
        run: |
          set -e
          CANDIDATES=$(grep -Rl '"scripts"' --include=package.json || true)
          DIR=$(echo "${CANDIDATES}" | grep -E '^frontend/package.json$' | sed 's#/package.json##')
          if [ -z "$DIR" ]; then
            DIR=$(echo "${CANDIDATES}" | head -n1 | sed 's#/package.json##')
          fi
          [ -f "$DIR/package.json" ] || (echo "package.json not found" && exit 1)
          echo "PROJECT_DIR=$DIR" >> $GITHUB_OUTPUT
          echo "📁 Project: $DIR"
          cat "$DIR/package.json"

      - name: Install deps (Yarn if yarn.lock exists)
        id: pm
        run: |
          set -e
          cd "${{ steps.detect.outputs.PROJECT_DIR }}"
          if [ -f yarn.lock ]; then
            echo "manager=yarn" >> $GITHUB_OUTPUT
            yarn install --frozen-lockfile || yarn install
            # Pin versi kompatibel
            yarn add react@18.3.1 react-dom@18.3.1 react-scripts@5.0.1 date-fns@3.6.0 --exact
          else
            echo "manager=npm" >> $GITHUB_OUTPUT
            # Jangan pakai npm ci (tidak ada package-lock)
            npm install --legacy-peer-deps
            npm install react@18.3.1 react-dom@18.3.1 react-scripts@5.0.1 date-fns@3.6.0 --save-exact --legacy-peer-deps
          fi

      - name: Build
        run: |
          set -e
          cd "${{ steps.detect.outputs.PROJECT_DIR }}"
          if [ "${{ steps.pm.outputs.manager }}" = "yarn" ]; then
            yarn build
          else
            npm run build --legacy-peer-deps
          fi

      - name: Zip build as site.zip
        run: |
          cd "${{ steps.detect.outputs.PROJECT_DIR }}/build"
          zip -r ../site.zip ./*

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: site
          path: ${{ steps.detect.outputs.PROJECT_DIR }}/site.zip
          if-no-files-found: error
